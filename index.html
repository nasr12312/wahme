<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© ØªØ±Ø§Ø¨ÙŠØ¹ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            touch-action: manipulation;
            background-color: #1a202c;
            background-image: url('https://www.transparenttextures.com/patterns/dark-denim-3.png');
        }
        .cell {
            transition: all 0.2s ease-in-out;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5), 0 2px 4px rgba(0,0,0,0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 40px;
        }
        .cell .coordinate {
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
            opacity: 0.5;
            font-size: clamp(0.7rem, 2vw, 1rem);
        }
        .cell:hover {
            transform: scale(1.1);
            z-index: 10;
            border-color: #67e8f9;
        }
        .cell-p1 { background-color: #3b82f6; }
        .cell-p2 { background-color: #ef4444; }
        .cell-p3 { background-color: #22c55e; }
        .cell-p4 { background-color: #eab308; }
        
        .board-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .explosion-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            background: radial-gradient(circle, rgba(255,240,150,1) 0%, rgba(255,100,50,1) 100%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: blast 0.6s ease-out forwards;
            pointer-events: none;
        }

        @keyframes blast {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(12); opacity: 0; }
        }
       
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.8); }
        .player-card.active {
            transform: scale(1.05);
            border-color: #67e8f9;
            box-shadow: 0 0 20px #67e8f9;
        }
        .timer-bar {
            transition: width 1s linear;
        }
        #pause-overlay {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        .control-button:disabled {
            background-color: #4a5568;
            cursor: not-allowed;
            transform: scale(1);
            opacity: 0.6;
        }
        .label-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #cbd5e1;
            background-color: #334155;
            cursor: default;
        }
         .label-cell:hover {
            transform: none;
            border-color: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <!-- Main Game Layout -->
    <div id="game-container" class="hidden md:flex w-full max-w-7xl mx-auto gap-8 items-start">
        
        <!-- Sidebar -->
        <div class="w-1/3 lg:w-1/4 bg-gray-800 bg-opacity-60 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-gray-700">
            <h1 class="text-4xl font-black mb-1 text-cyan-400 text-center">ØªØ±Ø§Ø¨ÙŠØ¹</h1>
            <p class="text-center text-gray-400 mb-6">Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠØ©</p>

            <div id="turn-info" class="text-center mb-6 p-3 rounded-lg bg-gray-900">
                <p class="text-lg">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰:</p>
                <p id="current-player-name" class="text-2xl font-bold"></p>
                <div id="timer-container" class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                    <div id="timer-bar" class="bg-cyan-400 h-2.5 rounded-full timer-bar" style="width: 100%"></div>
                </div>
            </div>

            <div id="players-scores" class="space-y-3">
                <!-- Player cards will be generated here -->
            </div>
            
            <div class="grid grid-cols-2 gap-2 mt-8">
                <button id="undo-button" class="control-button w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-lg font-bold transition-transform transform hover:scale-105">
                    ØªØ±Ø§Ø¬Ø¹
                </button>
                 <button id="pause-button" class="control-button w-full px-6 py-3 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-lg font-bold transition-transform transform hover:scale-105">
                    Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª
                </button>
                 <button id="reset-button" class="control-button col-span-2 w-full px-6 py-3 bg-red-600 hover:bg-red-700 rounded-lg text-lg font-bold transition-transform transform hover:scale-105">
                    Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨
                </button>
            </div>

        </div>

        <!-- Game Board with Coordinates -->
        <div class="relative flex-1 flex items-center justify-center">
             <div id="board-wrapper" class="inline-grid gap-1.5 p-3 rounded-lg bg-gray-800 bg-opacity-50 shadow-2xl">
                <!-- Board and labels will be generated by JavaScript -->
            </div>
            <div id="pause-overlay" class="hidden absolute inset-0 rounded-lg flex items-center justify-center">
                 <h2 class="text-5xl font-black text-white drop-shadow-lg">Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…ØªÙˆÙ‚ÙØ©</h2>
            </div>
        </div>
    </div>
    
    <!-- Mobile/Small Screen Message -->
    <div id="mobile-message" class="md:hidden text-center">
        <h1 class="text-3xl font-bold mb-4">Ù„Ø¹Ø¨Ø© ØªØ±Ø§Ø¨ÙŠØ¹</h1>
        <p class="text-lg">Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø¹Ø¨Ø© ØªØªØ·Ù„Ø¨ Ø´Ø§Ø´Ø© Ø£ÙƒØ¨Ø±. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù‡Ø§Ø² Ù„ÙˆØ­ÙŠ Ø£Ùˆ ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ù…ÙƒØªØ¨ÙŠ Ù„Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø©.</p>
    </div>


    <!-- Setup Modal -->
    <div id="setup-modal" class="modal-backdrop fixed inset-0 overflow-y-auto p-8 flex justify-center items-start">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-11/12 max-w-lg">
            <h2 class="text-3xl font-bold mb-4 text-center text-yellow-400">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
            
            <div class="mb-6">
                <h3 class="text-xl font-bold mb-2 text-center text-cyan-400">Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Ù‚</h3>
                <div class="flex justify-center gap-4">
                    <select id="player-count" class="w-full p-3 bg-gray-700 rounded border border-gray-600">
                        <option value="2">ÙØ±ÙŠÙ‚Ø§Ù†</option>
                        <option value="3">3 ÙØ±Ù‚</option>
                        <option value="4" selected>4 ÙØ±Ù‚</option>
                    </select>
                </div>
            </div>

            <div id="player-names-container" class="space-y-4">
                <input type="text" id="p1-name" class="w-full p-3 bg-gray-700 rounded border border-blue-500" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰" value="Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚">
                <input type="text" id="p2-name" class="w-full p-3 bg-gray-700 rounded border border-red-500" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©" value="Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±">
                <input type="text" id="p3-name" class="w-full p-3 bg-gray-700 rounded border border-green-500" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©" value="Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±">
                <input type="text" id="p4-name" class="w-full p-3 bg-gray-700 rounded border border-yellow-500" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©" value="Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø±Ø§Ø¨Ø¹">
            </div>

             <h3 class="text-xl font-bold mt-6 mb-2 text-center text-cyan-400">Ù†Ù…Ø· Ø§Ù„Ù„Ø¹Ø¨</h3>
            <div class="flex justify-center gap-4">
                <div>
                    <input type="radio" id="mode-competitive" name="game-mode" value="competitive" checked class="hidden peer">
                    <label for="mode-competitive" class="block cursor-pointer p-3 text-center rounded-lg border-2 border-gray-600 peer-checked:border-cyan-500 peer-checked:bg-cyan-900/50">
                        ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©<br><span class="text-xs text-gray-400">(Ù…Ø¤Ù‚Øª ÙˆØ£Ø¯ÙˆØ§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ©)</span>
                    </label>
                </div>
                <div>
                    <input type="radio" id="mode-free" name="game-mode" value="free" class="hidden peer">
                    <label for="mode-free" class="block cursor-pointer p-3 text-center rounded-lg border-2 border-gray-600 peer-checked:border-yellow-500 peer-checked:bg-yellow-900/50">
                        Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø±<br><span class="text-xs text-gray-400">(Ø¨Ø¯ÙˆÙ† Ù…Ø¤Ù‚Øª ÙˆØ§Ø®ØªÙŠØ§Ø± ÙŠØ¯ÙˆÙŠ)</span>
                    </label>
                </div>
            </div>
            <div class="mt-6 text-center">
                 <h3 class="text-xl font-bold mb-2 text-center text-red-400">Ø¥Ø¶Ø§ÙØ§Øª</h3>
                 <label for="enable-mines" class="flex items-center justify-center gap-2 text-lg text-gray-300 cursor-pointer mb-2">
                    <input type="checkbox" id="enable-mines" class="w-5 h-5 bg-gray-700 border-gray-600 rounded text-red-500 focus:ring-red-600">
                    ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ù„ØºØ§Ù… (5 Ø£Ù„ØºØ§Ù…)
                </label>
            </div>
            <button id="start-game-button" class="mt-8 w-full px-8 py-4 bg-green-600 hover:bg-green-700 rounded-lg text-xl font-bold transition-transform transform hover:scale-105">
                Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨!
            </button>
        </div>
    </div>
    
    <!-- Game Over Modal -->
    <div id="game-over-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center hidden">
        <div class="bg-gray-800 border-4 border-cyan-500 p-8 rounded-lg shadow-2xl w-11/12 max-w-md text-center">
            <h2 class="text-4xl font-bold mb-4" id="game-over-title">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</h2>
            <div id="game-over-ranking" class="text-xl mb-6 space-y-2"></div>
            <button id="play-again-button" class="px-8 py-3 bg-cyan-600 hover:bg-cyan-700 rounded-lg text-xl font-bold transition-transform transform hover:scale-105">
                Ø§Ù„Ø¹Ø¨ Ù…Ø¬Ø¯Ø¯Ø§Ù‹
            </button>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Config ---
    const GRID_SIZE = 10;
    const BOARD_SIZE = GRID_SIZE - 1;
    const MINE_COUNT = 5;
    const MINE_PENALTY = 5;
    const TURN_DURATION = 30;

    // --- State ---
    let boardState;
    let players;
    let currentPlayerIndex;
    let gameActive;
    let isPaused = false;
    let turnTimer;
    let timeLeftInTurn;
    let gameMode;
    let minesEnabled;
    let moveHistory = [];

    // --- DOM Elements ---
    const gameContainer = document.getElementById('game-container');
    const boardWrapper = document.getElementById('board-wrapper');
    const playersScoresContainer = document.getElementById('players-scores');
    const currentPlayerNameEl = document.getElementById('current-player-name');
    const timerContainer = document.getElementById('timer-container');
    const resetButton = document.getElementById('reset-button');
    const pauseButton = document.getElementById('pause-button');
    const undoButton = document.getElementById('undo-button');
    const pauseOverlay = document.getElementById('pause-overlay');
    // Modals
    const setupModal = document.getElementById('setup-modal');
    const playerCountSelect = document.getElementById('player-count');
    const playerNamesContainer = document.getElementById('player-names-container');
    const startGameButton = document.getElementById('start-game-button');
    const enableMinesCheckbox = document.getElementById('enable-mines');
    const gameOverModal = document.getElementById('game-over-modal');
    const gameOverTitle = document.getElementById('game-over-title');
    const gameOverRanking = document.getElementById('game-over-ranking');
    const playAgainButton = document.getElementById('play-again-button');
    
    // --- Initial Setup ---
    playerCountSelect.addEventListener('change', () => {
        const count = parseInt(playerCountSelect.value);
        for (let i = 1; i <= 4; i++) {
            const input = document.getElementById(`p${i}-name`);
            if (i <= count) {
                input.style.display = 'block';
            } else {
                input.style.display = 'none';
            }
        }
    });

    function setupGame() {
        gameMode = document.querySelector('input[name="game-mode"]:checked').value;
        minesEnabled = enableMinesCheckbox.checked;
        const playerCount = parseInt(playerCountSelect.value);
        
        const defaultPlayers = [
            { id: 1, name: 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚', score: 0, colorClass: 'cell-p1', borderClass: 'border-blue-500' },
            { id: 2, name: 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±', score: 0, colorClass: 'cell-p2', borderClass: 'border-red-500' },
            { id: 3, name: 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¶Ø±', score: 0, colorClass: 'cell-p3', borderClass: 'border-green-500' },
            { id: 4, name: 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø±Ø§Ø¨Ø¹', score: 0, colorClass: 'cell-p4', borderClass: 'border-yellow-500' },
        ];
        
        players = defaultPlayers.slice(0, playerCount);
        players.forEach((player, index) => {
            const inputName = document.getElementById(`p${index + 1}-name`).value;
            if (inputName) {
                player.name = inputName;
            }
        });
        
        setupModal.classList.add('hidden');
        gameContainer.classList.remove('hidden');
        gameContainer.classList.add('flex');
        initializeGame();
    }

    function initializeGame() {
        boardState = Array(BOARD_SIZE).fill(null).map(() => Array(BOARD_SIZE).fill(null).map(() => ({ owner: null, isMine: false })));
        if (minesEnabled) {
            placeMines();
        }
        
        moveHistory = [];
        undoButton.disabled = true;
        currentPlayerIndex = 0;
        gameActive = true;
        isPaused = false;
        pauseButton.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
        pauseOverlay.classList.add('hidden');
        
        gameOverModal.classList.add('hidden');
        renderBoard();
        renderPlayerCards();
        updateScores();

        if (gameMode === 'free') {
            timerContainer.classList.add('hidden');
            pauseButton.disabled = true;
            manuallySetTurn(0);
        } else {
            timerContainer.classList.remove('hidden');
            pauseButton.disabled = false;
            startTurn();
        }
    }

    function placeMines() {
        let minesPlaced = 0;
        while (minesPlaced < MINE_COUNT) {
            const r = Math.floor(Math.random() * BOARD_SIZE);
            const c = Math.floor(Math.random() * BOARD_SIZE);
            if (!boardState[r][c].isMine) {
                boardState[r][c].isMine = true;
                minesPlaced++;
            }
        }
    }

    function renderBoard() {
        boardWrapper.innerHTML = '';
        boardWrapper.style.gridTemplateColumns = `repeat(${GRID_SIZE}, 1fr)`;
        const arabicAlphabet = ['Ø£', 'Ø¨', 'Øª', 'Ø«', 'Ø¬', 'Ø­', 'Ø®', 'Ø¯', 'Ø°'];

        for (let row = 0; row < GRID_SIZE; row++) {
            for (let col = 0; col < GRID_SIZE; col++) {
                const cell = document.createElement('div');
                cell.className = 'w-full aspect-square rounded-md flex items-center justify-center text-xl';

                if (row === 0 || col === 0) {
                    cell.classList.add('label-cell');
                    if (row === 0 && col > 0) cell.textContent = col;
                    if (col === 0 && row > 0) cell.textContent = arabicAlphabet[row - 1];
                } else {
                    const boardRow = row - 1;
                    const boardCol = col - 1;
                    const cellData = boardState[boardRow][boardCol];
                    
                    cell.classList.add('cell', 'cursor-pointer', 'relative');
                    cell.dataset.row = boardRow;
                    cell.dataset.col = boardCol;
                    
                    const coordinateSpan = document.createElement('span');
                    coordinateSpan.className = 'coordinate font-bold text-white';
                    coordinateSpan.textContent = `${arabicAlphabet[boardRow]}${boardCol + 1}`;
                    cell.appendChild(coordinateSpan);

                    if (cellData.owner) {
                        cell.classList.add(players.find(p => p.id === cellData.owner).colorClass);
                    } else {
                        cell.classList.add('bg-gray-700', 'hover:bg-gray-600');
                    }
                    cell.addEventListener('click', handleCellClick);
                }
                boardWrapper.appendChild(cell);
            }
        }
    }
    
    function renderPlayerCards() {
        playersScoresContainer.innerHTML = '';
        players.forEach((player, index) => {
            const card = document.createElement('div');
            card.id = `player-card-${player.id}`;
            card.className = `player-card p-4 rounded-lg flex justify-between items-center transition-all duration-300 border-2 bg-gray-900`;
            card.classList.add(player.borderClass);

            card.innerHTML = `
                <span class="font-bold text-lg">${player.name}</span>
                <span id="player-${player.id}-score" class="text-2xl font-black">${player.score}</span>
            `;
            
            if (gameMode === 'free') {
                card.classList.add('cursor-pointer');
                card.addEventListener('click', () => manuallySetTurn(index));
            }
            playersScoresContainer.appendChild(card);
        });
    }

    function handleCellClick(event) {
        if (!gameActive || isPaused) return;
        const target = event.currentTarget;
        const row = parseInt(target.dataset.row);
        const col = parseInt(target.dataset.col);
        const cellData = boardState[row][col];
        const currentPlayer = players[currentPlayerIndex];
        
        if (cellData.owner === currentPlayer.id) {
            return;
        }

        moveHistory.push({
            board: JSON.parse(JSON.stringify(boardState)),
            players: JSON.parse(JSON.stringify(players))
        });
        undoButton.disabled = false;

        if (minesEnabled && cellData.isMine) {
            handleMineExplosion(row, col, target);
            return;
        }

        captureCell(row, col, currentPlayer);
    }
    
    function handleMineExplosion(row, col, cellElement) {
        const currentPlayer = players[currentPlayerIndex];
        boardState[row][col].isMine = false;
        
        boardWrapper.classList.add('board-shake');
        const explosionDiv = document.createElement('div');
        explosionDiv.className = 'explosion-effect';
        cellElement.appendChild(explosionDiv);

        setTimeout(() => {
            explosionDiv.remove();
            boardWrapper.classList.remove('board-shake');
        }, 600);
        
        currentPlayer.score -= MINE_PENALTY;

        const directions = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
        [...directions, [0,0]].forEach(([dr, dc]) => {
            const newRow = row + dr;
            const newCol = col + dc;
            if (isValid(newRow, newCol)) {
                boardState[newRow][newCol].owner = null;
            }
        });

        setTimeout(() => {
            updateScores();
            if (gameMode === 'competitive') nextTurn();
        }, 250);
    }
    
    function captureCell(row, col, player) {
        boardState[row][col].owner = player.id;
        
        const directions = [[-1, 0], [1, 0], [0, -1], [0, 1]];
        directions.forEach(([dr, dc]) => {
            const newRow = row + dr;
            const newCol = col + dc;
            if (isValid(newRow, newCol) && boardState[newRow][newCol].owner !== player.id) {
                boardState[newRow][newCol].owner = player.id;
            }
        });
        
        updateScores();
        
        if (checkWinCondition()) {
            endGame();
        } else if (gameMode === 'competitive') {
            nextTurn();
        }
    }

    function handleUndo() {
        if (moveHistory.length === 0 || isPaused) return;

        const lastState = moveHistory.pop();
        boardState = lastState.board;
        players = lastState.players;

        if (gameMode === 'competitive') {
            currentPlayerIndex = (currentPlayerIndex - 1 + players.length) % players.length;
            startTurn();
        } else {
            const activePlayer = players[currentPlayerIndex];
            if (activePlayer) {
                currentPlayerNameEl.textContent = activePlayer.name;
            }
        }

        renderPlayerCards();
        renderBoard();

        if (moveHistory.length === 0) {
            undoButton.disabled = true;
        }
    }

    function isValid(row, col) {
        return row >= 0 && row < BOARD_SIZE && col >= 0 && col < BOARD_SIZE;
    }

    function updateScores() {
        const scoreCount = {};
        players.forEach(p => scoreCount[p.id] = 0);
        
        for (let r = 0; r < BOARD_SIZE; r++) {
            for (let c = 0; c < BOARD_SIZE; c++) {
                const owner = boardState[r][c].owner;
                if (owner && scoreCount.hasOwnProperty(owner)) {
                    scoreCount[owner]++;
                }
            }
        }
        
        let totalOwned = 0;
        players.forEach(p => {
            const newScore = scoreCount[p.id];
            p.score = p.score < 0 && newScore === 0 ? p.score : newScore;
            
            const scoreEl = document.getElementById(`player-${p.id}-score`);
            if(scoreEl) scoreEl.textContent = p.score;
            totalOwned += p.score;
        });
        
        renderBoard();
        return totalOwned;
    }

    function startTurn() {
        if (gameMode !== 'competitive' || isPaused || !gameActive) return;
        clearInterval(turnTimer);
        const currentPlayer = players[currentPlayerIndex];
        currentPlayerNameEl.textContent = currentPlayer.name;
        
        document.querySelectorAll('.player-card').forEach(c => c.classList.remove('active'));
        const activeCard = document.getElementById(`player-card-${currentPlayer.id}`);
        if (activeCard) activeCard.classList.add('active');

        timeLeftInTurn = timeLeftInTurn || TURN_DURATION;
        const timerBarEl = document.getElementById('timer-bar');
        timerBarEl.style.width = `${(timeLeftInTurn / TURN_DURATION) * 100}%`;
        timerBarEl.style.transitionDuration = '1s';
        
        turnTimer = setInterval(() => {
            timeLeftInTurn--;
            const width = (timeLeftInTurn / TURN_DURATION) * 100;
            timerBarEl.style.width = `${width}%`;
            if (timeLeftInTurn <= 0) {
                nextTurn();
            }
        }, 1000);
    }
    
    function nextTurn() {
        if (gameMode !== 'competitive' || !gameActive) return;
        clearInterval(turnTimer);
        const timerBarEl = document.getElementById('timer-bar');
        if(timerBarEl) timerBarEl.style.transitionDuration = '0s';
        timeLeftInTurn = null; 
        currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
        if(gameActive) startTurn();
    }

    function manuallySetTurn(index) {
        if (!gameActive || isPaused || gameMode !== 'free') return;
        currentPlayerIndex = index;
        const currentPlayer = players[currentPlayerIndex];
        currentPlayerNameEl.textContent = currentPlayer.name;
        
        document.querySelectorAll('.player-card').forEach(c => c.classList.remove('active'));
        const activeCard = document.getElementById(`player-card-${currentPlayer.id}`);
        if(activeCard) activeCard.classList.add('active');
    }
        
    function checkWinCondition() {
        let totalOwnedCells = 0;
        for (let r = 0; r < BOARD_SIZE; r++) {
            for (let c = 0; c < BOARD_SIZE; c++) {
                if (boardState[r][c].owner) {
                    totalOwnedCells++;
                }
            }
        }
        return totalOwnedCells >= BOARD_SIZE * BOARD_SIZE;
    }

    function endGame() {
        gameActive = false;
        clearInterval(turnTimer);

        updateScores();
        const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
        
        gameOverTitle.textContent = sortedPlayers.length > 0 ? `ğŸ‰ ${sortedPlayers[0].name} Ù‡Ùˆ Ø§Ù„ÙØ§Ø¦Ø²! ğŸ‰` : 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!';
        gameOverRanking.innerHTML = sortedPlayers.map((p, index) => `
            <p class="font-bold">${index+1}. ${p.name}: <span class="text-cyan-400">${p.score}</span> Ù…Ø±Ø¨Ø¹</p>
        `).join('');

        gameOverModal.classList.remove('hidden');
    }

    function togglePauseGame() {
        if (gameMode !== 'competitive') return;
        isPaused = !isPaused;
        if(isPaused) {
            clearInterval(turnTimer);
            pauseButton.textContent = 'Ø§Ø³ØªØ¦Ù†Ø§Ù';
            pauseOverlay.classList.remove('hidden');
        } else {
            startTurn();
            pauseButton.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
            pauseOverlay.classList.add('hidden');
        }
    }
    
    startGameButton.addEventListener('click', setupGame);
    pauseButton.addEventListener('click', togglePauseGame);
    undoButton.addEventListener('click', handleUndo);
    resetButton.addEventListener('click', () => {
        clearInterval(turnTimer);
        gameContainer.classList.add('hidden');
        gameContainer.classList.remove('flex');
        setupModal.classList.remove('hidden');
    });
    playAgainButton.addEventListener('click', () => {
         gameOverModal.classList.add('hidden');
         gameContainer.classList.add('hidden');
         gameContainer.classList.remove('flex');
         setupModal.classList.remove('hidden');
    });

});
</script>

</body>
</html>

